# 🏎️ Track Editor Guide - トラックエディタガイド

## 概要

Web UIを使って直感的にレーシングコースを作成できるビジュアルエディタです。
これまでPythonコードを編集する必要があったトラック作成が、ドラッグ＆ドロップで簡単にできるようになりました。

## 使い方

### 1. エディタを開く

ブラウザで `track_editor.html` を開きます：

```bash
# Webブラウザで開く（お好きな方法で）
open track_editor.html          # macOS
xdg-open track_editor.html      # Linux
start track_editor.html         # Windows
```

または、直接ブラウザにファイルをドラッグ＆ドロップしてください。

### 2. トラックをデザイン

#### 基本操作

- **ウェイポイントを追加**: キャンバスをクリック
- **ウェイポイントを移動**: 「移動モードに切替」ボタンをクリックしてから、ウェイポイントをドラッグ
- **ウェイポイントを削除**: ウェイポイントを右クリック
- **ズーム**: マウスホイールで拡大/縮小

#### 設定パラメータ

- **コース幅**: トラックの幅をメートル単位で指定（デフォルト: 7.5m）
- **スケール**: ウェイポイント座標のスケーリング係数（デフォルト: 2.0）
- **スプライン解像度**: カーブの滑らかさ（デフォルト: 50ポイント）

### 3. トラックをエクスポート

#### 方法1: JSONファイルとして保存

1. 「📥 JSONでダウンロード」ボタンをクリック
2. `track.json` ファイルがダウンロードされます
3. このファイルをシミュレーションで使用できます

#### 方法2: Pythonコードをコピー

1. 「🐍 Pythonコードをコピー」ボタンをクリック
2. コードがクリップボードにコピーされます
3. `g_save.py` の `generate_complex_track()` 関数に貼り付けて使用

### 4. シミュレーションで使用

#### JSONファイルを使う場合

`g_save.py` を編集：

```python
# トラック設定
TRACK_JSON = "track.json"  # あなたのJSONファイルのパス
```

その後、通常通り実行：

```bash
python3 g_save.py
```

#### Pythonコードを直接貼り付ける場合

`g_save.py` の `generate_complex_track()` 関数内の `base_waypoints` を、
エディタからコピーしたコードで置き換えます。

## 機能詳細

### ビジュアル要素

- **グリッド**: 背景のグリッドで位置関係を把握
- **原点マーク**: 赤い十字がワールド座標の原点 (0, 0)
- **ウェイポイント**: 番号付きの円で表示（選択中は赤色）
- **点線**: ウェイポイント間の接続を表示
- **トラック**: Catmull-Romスプライン補間による滑らかなコース
- **ゴールライン**: 最初のウェイポイント位置にピンク色のラインで表示

### 統計情報

サイドバーに以下の情報が表示されます：

- **ウェイポイント数**: 配置したウェイポイントの総数
- **コース長**: 生成されたトラックの総延長（メートル）

### データ形式

#### JSON形式

```json
{
  "waypoints": [
    [0, -20],
    [-30, -20],
    [10, 40]
  ],
  "trackWidth": 7.5,
  "scale": 2.0
}
```

- `waypoints`: ウェイポイント座標の配列
- `trackWidth`: コース幅（メートル）
- `scale`: スケーリング係数

## トラックデザインのコツ

### 1. バランスの取れたレイアウト

- **適度なカーブ**: 急カーブと緩やかなカーブを混ぜる
- **十分な直線**: AIが加速できる区間を確保
- **適切なコース幅**: 7.5m前後が推奨（車両サイズ: 約2.5m）

### 2. ウェイポイント配置

- **最低3つ**: トラックを生成するには最低3つのウェイポイントが必要
- **8〜15個が推奨**: 複雑すぎず、単純すぎないコース
- **均等な間隔**: ウェイポイント間の距離が極端に違わないように

### 3. テストと調整

1. エディタでトラックをデザイン
2. JSONでエクスポート
3. シミュレーションで試走
4. 必要に応じてエディタで調整
5. 繰り返し

## トラブルシューティング

### Q: エディタが表示されない

**A**: モダンなWebブラウザを使用してください（Chrome, Firefox, Safari, Edge など）。
古いブラウザではHTML5 Canvasがサポートされていない可能性があります。

### Q: トラックが表示されない

**A**: 以下を確認してください：
- ウェイポイントが最低3つ配置されているか
- ウェイポイントが画面外に配置されていないか（ズームアウトして確認）
- ブラウザの開発者コンソールにエラーが表示されていないか

### Q: JSONファイルが読み込めない

**A**: 
- ファイルが正しいJSON形式か確認
- ファイルの文字コードがUTF-8になっているか確認
- track_loader.pyを使って検証：
  ```bash
  python3 track_loader.py track.json
  ```

### Q: シミュレーションでトラックが変わらない

**A**: 
- `g_save.py` で `TRACK_JSON = "track.json"` を設定したか確認
- JSONファイルが `g_save.py` と同じディレクトリにあるか確認
- パスを相対パスまたは絶対パスで正しく指定しているか確認

## 高度な使い方

### カスタムスタート位置

JSONファイルの最初のウェイポイントがスタート/ゴール位置になります。
配置順序を変更したい場合は、エディタで削除＆再配置するか、JSONファイルを直接編集してください。

### 既存トラックの編集

1. 「📂 ファイルを開く」ボタンをクリック
2. 既存の `track.json` を選択
3. エディタに読み込まれるので編集
4. 再度エクスポート

### バージョン管理

複数のトラックデザインを保存する場合：
- 異なるファイル名で保存（例: `track_simple.json`, `track_complex.json`）
- `g_save.py` で使用するトラックを切り替え

## サンプルトラック

### シンプルな楕円コース

```json
{
  "waypoints": [
    [0, 0],
    [50, 0],
    [50, 30],
    [0, 30]
  ],
  "trackWidth": 10.0,
  "scale": 2.0
}
```

### テクニカルコース

デフォルトで読み込まれているトラックは14個のウェイポイントを使った
複雑なレイアウトです。これをベースにカスタマイズすることをお勧めします。

## 技術詳細

### Catmull-Romスプライン補間

エディタとシミュレーションは同じアルゴリズムを使用してトラックを生成します：

- 各ウェイポイント間を滑らかな曲線で接続
- 通過点（ウェイポイント）は曲線上に正確に配置
- 連続的なカーブで自然なコースレイアウト

### 座標系

- エディタ: 上方向がY軸正の方向
- シミュレーション: 数学的座標系と一致
- スケール係数で実際のメートル単位に変換

## フィードバック

トラックエディタの改善案やバグ報告は、GitHubのIssueでお知らせください！

---

**作成日**: 2025-12-05
