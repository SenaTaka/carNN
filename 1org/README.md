# 車シミュレーション - 遺伝的アルゴリズムによるニューラルネットワーク学習

このプロジェクトは、遺伝的アルゴリズムを使用してニューラルネットワークを進化させ、サーキットを自律走行する車をシミュレートします。

## 概要

C言語で実装された高速な遺伝的アルゴリズムにより、車の制御を行うニューラルネットワークを学習します。車はセンサーから得られる情報を基に、ステアリングとスロットルを制御してコース上を走行します。

## 主な機能

- **OpenMPによる並列計算**: マルチスレッドで高速に進化計算を実行
- **キネマティックバイシクルモデル**: 物理的に妥当な車両運動モデル
- **センサーベースの制御**: 5つのセンサーで周囲の壁までの距離を検知
- **進化的学習**: 200個体を500世代にわたり進化させる
- **可視化機能**: Pythonスクリプトで学習結果を視覚的に確認

## ファイル構成

- `nn_evolve.c` - メインの遺伝的アルゴリズム実装（C言語）
- `run_and_show.py` - コンパイル・実行・可視化を行うPythonスクリプト
- `track.txt` - サーキットコースの座標データ
- `all_pop.weights` - 学習後の全個体の重みデータ（バイナリ）
- `best.weights` - 最良個体の重みデータ

## 必要な環境

### C言語コンパイラ
- GCC（OpenMP対応）
- 数学ライブラリ（libm）

### Python環境
- Python 3.x
- matplotlib（可視化用）

## インストール

```bash
# Ubuntuの場合
sudo apt-get install gcc
pip install matplotlib

# macOSの場合
brew install gcc
pip install matplotlib
```

## 使い方

### 1. 簡単な実行（推奨）

Pythonスクリプトを使用すると、コンパイル・実行・可視化が一括で行えます。

```bash
python run_and_show.py
```

このスクリプトは以下の処理を自動的に行います：
1. サーキットコースの生成（track.txt）
2. C言語コードのコンパイル
3. 遺伝的アルゴリズムの実行
4. 結果の可視化

### 2. 手動実行

#### コンパイル
```bash
gcc -O3 -lm -fopenmp -o nn_evolve nn_evolve.c
```

#### 実行
```bash
./nn_evolve track.txt [スレッド数]
```

- 第1引数: トラックファイル（必須）
- 第2引数: 使用するスレッド数（省略時: 20）

例:
```bash
./nn_evolve track.txt 8
```

## 出力

実行中、以下のような進捗が表示されます：

```
Track loaded: 400 points, Total Length: 1234.56
Gen 0 Best Fitness: 0.1234 (12.3% Lap)
Gen 10 Best Fitness: 0.3456 (34.6% Lap)
Gen 20 Best Fitness: 0.5678 (56.8% Lap)
...
Done.
```

- **Best Fitness**: 最良個体の適応度（コース完走率）
- **% Lap**: 完走率のパーセント表示

## アルゴリズムの詳細

### ニューラルネットワーク構造
- 入力層: 6ノード（5つのセンサー + 速度）
- 隠れ層: 12ノード（tanh活性化関数）
- 出力層: 2ノード（ステアリング、スロットル）

### 遺伝的アルゴリズムのパラメータ
- 個体数: 200
- 世代数: 500
- エリート保存: 20個体
- 選択方法: トーナメント選択
- 交叉: 一点交叉
- 変異率: 5%（世代とともに減衰）

### 評価関数
車は以下の基準で評価されます：
- コースの進行距離（完走率の変化量で重み付け）
- コース逆走へのペナルティ
- コースアウトへのペナルティ
- 低速停止へのペナルティ

### センサー配置
5つのセンサーが車の前方に配置され、壁までの距離を測定します：
- 左前方: -1.2ラジアン
- 左: -0.6ラジアン
- 正面: 0.0ラジアン
- 右: 0.6ラジアン
- 右前方: 1.2ラジアン

## カスタマイズ

### パラメータの変更

`nn_evolve.c`内の以下の定数を変更できます：

```c
int GENS = 500;     // 世代数
int STEPS = 2000;   // 1個体あたりのシミュレーションステップ数
int NSENS = 5;      // センサー数
double maxdist = 50.0;  // センサーの最大検知距離
```

### コースの変更

`run_and_show.py`の`write_light_track`関数を編集するか、独自の`track.txt`を作成してください。

トラックファイルの形式：
```
<点数> <幅の半分>
<x1> <y1>
<x2> <y2>
...
```

## パフォーマンス

- OpenMP並列化により、マルチコアCPUを効率的に活用
- デフォルト20スレッドで実行
- 500世代の学習が数分～数十分で完了（CPU性能に依存）

## トラブルシューティング

### コンパイルエラー
- OpenMPが有効になっていない場合: `-fopenmp`オプションを確認
- 数学ライブラリがリンクされていない場合: `-lm`オプションを確認

### 実行エラー
- `track.txt`が見つからない: ファイルの存在を確認
- セグメンテーションフォルト: スタックサイズを増やす（`ulimit -s unlimited`）

### 可視化エラー
- matplotlibがインストールされていない: `pip install matplotlib`
- ディスプレイがない環境: バックエンドを変更（`matplotlib.use('Agg')`）

## ライセンス

このプロジェクトは教育目的で作成されています。

## 作者

M1プロジェクト

## 参考文献

- 遺伝的アルゴリズム
- ニューラルネットワーク
- キネマティックバイシクルモデル
- 進化的計算
